name: "2 SYFT, COSIGN"
on:
  push:
    branches: [ "3.6.0_release" ]
  pull_request:
    branches: [ "3.6.0_release" ]

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest

    steps:
    - name: Clean up workspace
      run: |
        cd $GITHUB_WORKSPACE
        rm -rf *
        docker inspect --format='{{index .RepoDigests 0}}' ubuntu:latest
    
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Build Kafka
      run: |
        ./gradlew clean
        ./gradlew assemble

    - name: Generate SBOM
      run: |
        wget https://github.com/spdx/spdx-sbom-generator/releases/latest/download/spdx-sbom-generator.jar
        java -jar spdx-sbom-generator.jar -d <path-to-kafka-binary-directory> -o sbom.spdx.json

    - name: Publish SBOM as artifact
      uses: actions/upload-artifact@v2
      with:
        name: sbom
        path: sbom.spdx.json

    # - name: Login to Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     username: sandhya817
    #     password: dckr_pat_U95WTk6Fm0tbnMcn3ew5i09TIcI

    # - name: Installing SBOM
    #   run: |
    #     curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b .

    # - name: Generate SBOM
    #   run: |
    #     ./syft . -o spdx-tag-value=sbom-syft.spdx
    - name: Install Cosign
      run: |
        COSIGN_VERSION=v1.4.0
        wget -O cosign https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64
        chmod +x cosign
        sudo mv cosign /usr/local/bin/cosign

    - name: generate cosign key  
      id: generate_secret 
      run: |
        cosign generate-key-pair
        echo .
        pwd
        ls -al
        echo $GITHUB_WORKSPACE

    - name: sign cosign
      run: |
        cosign sign --key $GITHUB_WORKSPACE/cosign.key $GITHUB_WORKSPACE/sbom-syft.spdx
